<!DOCTYPE html>

<style>
	* {
		margin: 0;
		padding: 0;
		font-family: "Cabin Sketch", cursive;
		font-weight: bold;
	}

	footer {
		text-align: left;
		position: fixed;
		bottom: 10px;
		left: 10px;
		width: 20%;
	}

	/*
		Move these into the desktop styling someday, ik im lazy for not doing it rn
	*/
	footer input {
		width: 75%;
	}

	footer button {
		width: 20%;
		font-size: 1em;
	}

	body {
		text-align: center;
		background: linear-gradient(to bottom right, #000000, #1f1f1f);
		color: whitesmoke;
	}

	table, th, td {
		border-collapse: collapse;
		border: 5px double #753f00;
	}

	input {
		background-color: black;
		border: 3px solid #753f00;
		color: whitesmoke;
	}

	a {
		color: whitesmoke;
		text-decoration: none;
	}

	li div button {
		text-overflow: ellipsis;
	}


	@media only screen and (min-width: 1582px) {

		h1 {
			font-size: 3em;
		}

		body {
			display: flex;
			height: 100vh;
			width: 100vw;
			justify-content: space-evenly;
		}

		body div {
			width: 30%;
		}

		li {
			display: flex;
		}
		li * {
			display: inline-block;
		}

		button {
			font-size: 2em;
		}

		li div {
			width: 100%;
			text-align: left;
		}

		li div p {
			width: 68.5%;
			overflow: hidden;
			font-size: 2em;
		}

		li div button {
			text-overflow: ellipsis;
			width: 20%;
		}

		.removeButton {
			width: 10%;
		}

		th, td {
			user-select: none;
		}

		th {
			font-size: 2em;
		}

		td {
			text-align: center;
			font-size: 4em;
			min-width: 2em;
		}


		#add_item_field {
			font-size: 2.5em;
			width: 83%;
		}
		
		#add_item_button {
			width: 15%;

		}
	}

	@media only screen and (max-width: 1582px) {
		h1 {
			margin: 30px 0px 30px 0px;
		}

		table {
			width: 100vw;
			margin-bottom: 100px;
		}

		th {
			font-size: 3.5em;
		}

		td {
			width: 20%;
			font-size: 7em;
		}

		#buy_list {
			font-size: 4em;
		}

		li {
			padding: 30px 0 30px 0;
			width: 100%;
			text-align: left;
			border-bottom: 5px solid black;
		}

		li div {
			display: flex;
			width: 100%;
		}

		li div p {
			width: 74%
		}

		li div button {
			width: 10%;
			font-size: 1em;
			height: 2em;
			margin-left: 3%;
		}

		input {
			font-size: 1em;
			width: 90%;
		}

		form button {
			width: 10%;
			font-size: 0.8em;
		}

		form {
			display: flex;
		}

		footer {
			display: none;
		}

	}

</style>


<html>
	<head>
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Cabin+Sketch:wght@400;700&display=swap" rel="stylesheet">
		<title>Sis50's Chalkboard</title>
	</head>

	<body>
		<div id="attendance_table">
			<table>
				<tr>
					<th><a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">Rick<a></th>
					<th>Youri</th>
					<th>Robert</th>
					<th>Milan</th>
					<th>Dag</th>
				</tr>

				<tr>
					<td id="rick-monday" onclick="changeDayStatus(this.id)">X</td>
					<td id="youri-monday" onclick="changeDayStatus(this.id)">X</td>
					<td id="robert-monday" onclick="changeDayStatus(this.id)">X</td>
					<td id="milan-monday" onclick="changeDayStatus(this.id)">X</td>
					<td id="dag-monday">Ma</td>
				</tr>

				<tr>
					<td id="rick-tuesday" onclick="changeDayStatus(this.id)">X</td>
					<td id="youri-tuesday" onclick="changeDayStatus(this.id)">X</td>
					<td id="robert-tuesday" onclick="changeDayStatus(this.id)">X</td>
					<td id="milan-tuesday" onclick="changeDayStatus(this.id)">X</td>
					<td id="dag-tuesday">Di</td>
				</tr>

				<tr>
					<td id="rick-wednesday" onclick="changeDayStatus(this.id)">X</td>
					<td id="youri-wednesday" onclick="changeDayStatus(this.id)">X</td>
					<td id="robert-wednesday" onclick="changeDayStatus(this.id)">X</td>
					<td id="milan-wednesday" onclick="changeDayStatus(this.id)">X</td>
					<td id="dag-wednesday">Wo</td>
				</tr>

				<tr>
					<td id="rick-thursday" onclick="changeDayStatus(this.id)">X</td>
					<td id="youri-thursday" onclick="changeDayStatus(this.id)">X</td>
					<td id="robert-thursday" onclick="changeDayStatus(this.id)">X</td>
					<td id="milan-thursday" onclick="changeDayStatus(this.id)">X</td>
					<td id="dag-thursday">Do</td>
				</tr>

				<tr>
					<td id="rick-friday" onclick="changeDayStatus(this.id)">X</td>
					<td id="youri-friday" onclick="changeDayStatus(this.id)">X</td>
					<td id="robert-friday" onclick="changeDayStatus(this.id)">X</td>
					<td id="milan-friday" onclick="changeDayStatus(this.id)">X</td>
					<td id="dag-friday">Vr</td>
				</tr>

				<tr>
					<td id="rick-saturday" onclick="changeDayStatus(this.id)">X</td>
					<td id="youri-saturday" onclick="changeDayStatus(this.id)">X</td>
					<td id="robert-saturday" onclick="changeDayStatus(this.id)">X</td>
					<td id="milan-saturday" onclick="changeDayStatus(this.id)">X</td>
					<td id="dag-saturday">Za</td>
				</tr>

				<tr>
					<td id="rick-sunday" onclick="changeDayStatus(this.id)">X</td>
					<td id="youri-sunday" onclick="changeDayStatus(this.id)">X</td>
					<td id="robert-sunday" onclick="changeDayStatus(this.id)">X</td>
					<td id="milan-sunday" onclick="changeDayStatus(this.id)">X</td>
					<td id="dag-sunday">Zo</td>
				</tr>
			</table>
		</div>
		<div id="buy_list">
			<h1>Nodig</h1>
			<form action="" onsubmit="addItemMessage(event)">
				<input id="add_item_field" type="text"/>
				<button id="add_item_button">+</button>
			</form>
			<ul id="item_list">

			</ul>
		</div>
	</body>

	<footer>

		<form action="" onsubmit="changeBackgroundImage(event)">
			<input id="new_background" type="text"/>
			<button>Wijziging</button>
		</form>


	</footer>
</html>

<script>
	// CONSTANT STATE
	var days_map = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"]
	var all_people = ["rick", "youri", "robert", "milan", "dag"]
	var day_states = [ "<space></space>", "X", "O", "?" ];

	// make sure this connects to the correct server
	var ws = new WebSocket("ws://172.104.143.161/ws")
	//var ws = new WebSocket("ws://127.0.0.1:8000/ws")

	// CLIENT SIDE FUNCTIONS
	function changeBackgroundImage(event) {

		var new_background_url = document.getElementById("new_background").value;
		var body = document.getElementsByTagName("body")[0];

		var table = document.getElementsByTagName("table")[0];
		var buy_list = document.getElementById("buy_list");

		if (new_background_url != "") {
			body.style.backgroundImage = `url(${new_background_url})`;
			body.style.backgroundSize = "cover";

			table.style.backgroundColor = "#ffffff0f"
			buy_list.style.backgroundColor = "#ffffff0f"
			localStorage.setItem("background-url", `${new_background_url}`)

		} else {
			body.style.background = "linear-gradient(to bottom right, #000000, #1f1f1f)";
			buy_list.style.backgroundColor = "#00000000";
			table.style.backgroundColor = "#00000000";
			localStorage.setItem("background-url", "")
		}

		event.preventDefault();
	}

	// changing saved background image

	try {
		var backgroundUrl = localStorage.getItem("background-url");
		console.log(`background: ${backgroundUrl}`)
		if (backgroundUrl != "") {

		var body = document.getElementsByTagName("body")[0];

		var table = document.getElementsByTagName("table")[0];
		var buy_list = document.getElementById("buy_list");
			body.style.backgroundImage = `url(${backgroundUrl})`;
			body.style.backgroundSize = "cover";

			table.style.backgroundColor = "#ffffff0f"
			buy_list.style.backgroundColor = "#ffffff0f"
			localStorage.setItem("background-url", `${backgroundUrl}`)
			console.log("read and changed");
		}
	} catch (error) {
		console.log(error)
		localStorage.setItem("background-url", "")
	}

	function newModelItem(itemCount, itemName) {
		return `<div>
			<p id="text-${itemCount}">${itemName}</p>
			<button id="${itemCount}e" onclick="editItem(this.id)">Editen</button>
			<button class="removeButton" id="${itemCount}" onclick="removeItemMessage(this.id)">X</button>
			</div>`
	}


	function highlightCurrentDayRow() {

		var current_date = new Date();
		var today = days_map[current_date.getDay()]

		for (var i = 0; i < all_people.length; i++) {
			var select_person = `${all_people[i]}-${today}`
			var select_element = document.getElementById(select_person);
			console.log(`changed ${select_person}`);
			select_element.style.backgroundColor = '#0a3b0a';
		}
	}
	highlightCurrentDayRow();


	/**
	 * DATA FORMAT
	 * [event]^[itemId]^[newValue]
	**/

	// SERVER INTERACTION FUNCTIONS
	ws.onmessage = function(event) {

		var itemList = document.getElementById("item_list");

		// unpacking the message received
		var message = event.data.split("^");

		var messageType = message[0];
		var mEffectedItem = message[1];
		var mNewValue = message[2];

		console.log(message);

		if (messageType == "addItem") {
			var newListItem = document.createElement("li")
			newListItem.setAttribute("id", `list_item-${mEffectedItem}`)
			newListItem.innerHTML = newModelItem(mEffectedItem, mNewValue);

			itemList.appendChild(newListItem);
		} else if (messageType == "deleteItem") {
			document.getElementById(mEffectedItem).remove();
			
		} else if (messageType == "changeDay") {
			document.getElementById(mEffectedItem).innerHTML = mNewValue;
		} else if (messageType == "editItem") {
			document.getElementById(`text-${mEffectedItem}`).innerHTML = mNewValue;
		}
	};

	function editItem(itemId) {
		var itemToEditId = itemId.slice(0, -1) // cut off last character which is e
		var toChangeElement = document.getElementById(`text-${itemToEditId}`);
		var newItemName = prompt("Edit Item", `${toChangeElement.innerHTML}`);

		ws.send(`editItem^${itemToEditId}^${newItemName}`)
	}

	function removeItemMessage(itemId) {
		var itemValue = document.getElementById(`text-${itemId}`).innerHTML;
		ws.send(`deleteItem^list_item-${itemId}^${itemValue}`)
		console.log(`deleteItem^list_item-${itemId}^${itemValue}`);
	}

	function addItemMessage(event) {
		var newItem = document.getElementById("add_item_field");
		if (!(newItem.value === "")) {
			ws.send(`addItem^_^${newItem.value}`);
			console.log(`addItem^_^${newItem.value}`)
		}
		newItem.value="";
		event.preventDefault();
	}

	function changeDayStatus(itemId) {
		var current_day = document.getElementById(itemId);
		var current_day_state = current_day.innerHTML;
		var new_index = (day_states.indexOf(current_day_state) + 1) % day_states.length;
		ws.send(`changeDay^${itemId}^${day_states[new_index]}`);
		console.log(`changeDay^${itemId}^${day_states[new_index]}`)
	}

	ws.onopen = function() {
		 ws.send("retrieveState^_^_") 
	};
	// retrieves the most up-to-date for the given user, !!NOT BROADCAST!!
	// will be received as fragments of all possible operations, instead of as one big string

</script>
